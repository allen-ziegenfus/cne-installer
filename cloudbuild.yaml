steps:
  # Step 0: Build Helm Dependencies
  - name: 'alpine/helm:3.17.1'
    id: 'Build Helm Deps'
    entrypoint: 'sh'
    args:
      - '-c'
      - |
        cd cloud/terraform/gcp/gke/helm/gateway-infra && helm dependency build

  # Step 1: Security Scan (Checkov)
  - name: 'bridgecrew/checkov:latest'
    id: 'Security Scan - Checkov'
    args:
      - '--directory=cloud/terraform'
      - '--download-external-modules=true'
      - '--compact'
      - '--soft-fail'

  # Step23: Security Scan (Trivy)
  - name: 'aquasec/trivy:latest'
    id: 'Security Scan - Trivy'
    entrypoint: 'trivy'
    args:
      - 'fs'
      - '.'
      - '--severity=HIGH,CRITICAL'
      - '--exit-code=0'

  # Step 3: Deploy Artifact Registry (GAR)
  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
    id: 'Deploy GAR'
    entrypoint: 'gcloud'
    args: 
      - 'infra-manager'
      - 'deployments'
      - 'apply'
      - 'projects/${PROJECT_ID}/locations/${_REGION}/deployments/gar-registry'
      - '--service-account=projects/${PROJECT_ID}/serviceAccounts/infra-manager-runner@${PROJECT_ID}.iam.gserviceaccount.com'
      - '--local-source=cloud/terraform/gcp/gar'
      - '--inputs-file=terraform.tfvars'

  # Step 4: Deploy the Network/Base stack
  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
    id: 'Deploy GKE'
    entrypoint: 'gcloud'
    args: 
      - 'infra-manager'
      - 'deployments'
      - 'apply'
      - 'projects/${PROJECT_ID}/locations/${_REGION}/deployments/gke-network'
      - '--service-account=projects/${PROJECT_ID}/serviceAccounts/infra-manager-runner@${PROJECT_ID}.iam.gserviceaccount.com'
      - '--local-source=cloud/terraform/gcp/gke'
      - '--inputs-file=terraform.tfvars'

  # Step 5: Deploy the GKE/Cluster stack
  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
    entrypoint: 'gcloud'
    id: Gitops Platform
    args:
      - 'infra-manager'
      - 'deployments'
      - 'apply'
      - 'projects/${PROJECT_ID}/locations/${_REGION}/deployments/gitops-platform'
      - '--service-account=projects/${PROJECT_ID}/serviceAccounts/infra-manager-runner@${PROJECT_ID}.iam.gserviceaccount.com'
      - '--local-source=cloud/terraform/gcp/gitops/platform'
      - '--inputs-file=terraform.tfvars'

substitutions:
  _REGION: 'us-central1'
